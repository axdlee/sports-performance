# 🎯 v1.4.0 新功能使用指南

## 📋 概述

v1.4.0版本为体育成绩评估系统添加了三大核心功能：

1. **日志系统** - 记录所有操作，便于问题追踪
2. **数据导出** - 导出成绩为CSV或Excel格式
3. **备份管理** - 完整的数据备份和恢复功能

---

## 📊 数据导出功能

### 使用步骤

1. **登录系统**
   - 打开应用程序
   - 登录或选择用户

2. **点击导出按钮**
   - 在主窗口点击 `💾 导出数据` 按钮
   - 前提：用户必须有至少一条成绩记录

3. **选择导出格式**
   - 弹出格式选择菜单
   - 选择 `📄 导出为 CSV` 或 `📊 导出为 Excel`

4. **选择保存位置**
   - 选择要保存文件的目录
   - 系统会自动生成文件名（格式：`用户名_成绩记录_时间戳.扩展名`）

5. **完成导出**
   - 导出成功会弹出提示框，显示文件路径
   - 状态栏会显示导出结果

### 导出格式说明

#### CSV格式

- **编码**: UTF-8-sig（Excel中文兼容）
- **包含内容**:
  - 日期
  - 必选项目、成绩、得分
  - 第一类选考项目、成绩、得分
  - 第二类选考项目、成绩、得分
  - 总分、等级
- **适用场景**: 数据分析、批量处理

#### Excel格式

- **样式**:
  - 表头：绿色背景 + 白色粗体文字
  - 数据：居中对齐 + 边框
  - 等级着色：
    - 优秀：浅绿色背景
    - 良好：浅蓝色背景
    - 不及格：浅红色背景
- **适用场景**: 打印报表、数据展示

### 注意事项

⚠️ **Excel导出依赖**

- 需要安装 `openpyxl` 库
- 如果未安装，只能使用CSV格式
- 安装命令: `pip install openpyxl>=3.1.0`

---

## 💾 备份管理功能

### 使用步骤

#### 1. 打开备份管理界面

- 在主窗口点击 `💾 备份管理` 按钮
- 不需要登录即可使用

#### 2. 创建备份

- 点击 `➕ 创建新备份` 按钮
- 系统会自动创建备份到备份目录
- 文件名格式: `backup_YYYYMMDD_HHMMSS.json`
- 备份成功会弹出提示

#### 3. 查看备份列表

- 备份列表自动显示所有备份文件
- 显示信息：
  - 文件名
  - 文件大小
  - 创建时间
- 按创建时间降序排列（最新的在最上面）

#### 4. 恢复备份

- 在备份列表中选择要恢复的备份
- 点击 `⏮ 恢复选中备份` 按钮
- **重要**: 系统会弹出确认对话框
- **安全机制**: 恢复前会自动创建当前数据的安全备份（名为`pre_restore_backup.json`）
- 确认后执行恢复
- 恢复成功后建议重新登录

#### 5. 删除备份

- 在备份列表中选择要删除的备份
- 点击 `🗑 删除选中备份` 按钮
- 确认后删除

#### 6. 刷新列表

- 点击 `🔄 刷新列表` 按钮
- 重新加载备份列表

### 备份文件位置

- **开发环境**: `data/backups/`
- **macOS打包后**: `~/Library/Application Support/SportsPerformance/backups/`
- **Windows打包后**: `%APPDATA%\SportsPerformance\backups\`

### 自动备份

系统会在以下情况自动创建备份：

1. **每日首次启动** - 如果当天还没有备份，会自动创建
2. **恢复备份前** - 自动创建安全备份（`pre_restore_backup.json`）

### 备份清理

- 系统会自动保留最近的**10个**自动备份
- 超过数量会自动删除最旧的备份
- **手动命名的备份**不会被自动删除

### 注意事项

⚠️ **重要提示**

1. 恢复备份会**覆盖当前数据**，请确认后操作
2. 恢复前的数据会自动备份为 `pre_restore_backup.json`
3. 定期创建备份以防数据丢失
4. 备份文件是JSON格式，可以手动查看和编辑（不推荐）

---

## 📋 日志系统

### 日志文件位置

- **开发环境**: `logs/app_YYYYMMDD.log`
- **macOS打包后**: `~/Library/Application Support/SportsPerformance/logs/`
- **Windows打包后**: `%APPDATA%\SportsPerformance\logs\`

### 日志级别

系统记录以下级别的日志：

- **DEBUG**: 详细的调试信息
- **INFO**: 一般信息（如操作成功）
- **WARNING**: 警告信息（如用户已存在）
- **ERROR**: 错误信息（如文件读写失败）
- **CRITICAL**: 严重错误

### 日志内容

日志会记录：

- 所有数据操作（加载、保存、添加、更新、删除）
- 用户操作（登录、注册、录入成绩）
- 导出和备份操作
- 异常和错误信息（包含堆栈跟踪）

### 日志文件管理

- **单文件大小**: 最大10MB
- **文件轮转**: 自动轮转
- **保留文件**: 保留最近5个文件
- **文件命名**: `app_YYYYMMDD.log`（按日期）

### 查看日志

#### macOS

```bash
# 查看当天日志
tail -f ~/Library/Application\ Support/SportsPerformance/logs/app_*.log

# 或打开日志目录
open ~/Library/Application\ Support/SportsPerformance/logs/
```

#### Windows

```cmd
# 打开日志目录
explorer %APPDATA%\SportsPerformance\logs
```

#### 开发环境

```bash
# 查看当天日志
tail -f logs/app_*.log
```

### 用途

日志可以帮助：

1. **问题诊断** - 当程序出现问题时，查看日志了解详细信息
2. **操作审计** - 追踪谁在什么时候做了什么操作
3. **性能分析** - 查看操作耗时
4. **错误追踪** - 查看错误堆栈，快速定位问题

---

## 🚀 快速测试

### 测试新功能

运行测试脚本验证所有新功能：

```bash
# 激活虚拟环境
source venv/bin/activate  # macOS/Linux
venv\Scripts\activate     # Windows

# 安装新依赖
pip install -r requirements.txt

# 运行测试脚本
python3 test_optimization.py
```

测试脚本会验证：

1. ✅ 日志系统
2. ✅ 数据导出（CSV和Excel）
3. ✅ 备份管理
4. ✅ 异常处理

---

## 📞 常见问题

### Q1: Excel导出失败怎么办？

**A**: 确认是否安装了openpyxl库

```bash
pip install openpyxl>=3.1.0
```

### Q2: 找不到日志文件？

**A**:

- 开发环境：检查项目根目录的 `logs/` 文件夹
- 打包环境：
  - macOS: `~/Library/Application Support/SportsPerformance/logs/`
  - Windows: `%APPDATA%\SportsPerformance\logs\`

### Q3: 备份恢复后数据还是旧的？

**A**: 恢复备份后建议：

1. 重新登录
2. 或点击"切换用户"重新选择用户

### Q4: 如何手动备份数据？

**A**:

1. 打开备份管理界面
2. 点击"➕ 创建新备份"
3. 备份文件保存在备份目录

### Q5: 导出的Excel文件中文乱码？

**A**:

- CSV文件使用UTF-8-sig编码，Excel应能正确打开
- 如果仍有问题，尝试：
  1. 使用Excel的"数据" → "从文本/CSV"导入
  2. 选择UTF-8编码

---

## 📝 版本信息

- **版本**: v1.4.0
- **发布日期**: 2025-11-19
- **Python版本**: 3.7+
- **新增依赖**: openpyxl, python-dateutil

---

**享受新功能！如有问题，请查看日志文件或联系开发团队。** 🎉
