name: Build Windows Installer

on:
  push:
    tags:
      - 'v*'  # 当推送 v 开头的标签时触发，如 v1.0.0
  workflow_dispatch:  # 允许手动触发
    inputs:
      version:
        description: '版本号 (例如: 1.3.1)'
        required: false
        default: '1.3.1'

jobs:
  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    
    steps:
      - name: Checkout 代码
        uses: actions/checkout@v4
      
      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: 构建 Windows 安装包
        run: |
          python build.py
      
      - name: 检查构建结果
        run: |
          if (Test-Path "dist/installer_windows") {
            Write-Host "✓ Windows 安装包构建成功"
            Get-ChildItem -Path "dist/installer_windows" -Recurse | Select-Object FullName
          } else {
            Write-Error "✗ 构建失败：未找到安装包目录"
            exit 1
          }
        shell: powershell
      
      - name: 创建 ZIP 压缩包
        run: |
          $version = "${{ github.event.inputs.version }}"
          if ([string]::IsNullOrEmpty($version)) {
            $version = "${{ github.ref_name }}" -replace '^v', ''
          }
          if ([string]::IsNullOrEmpty($version)) {
            $version = "1.3.1"
          }
          $zipName = "SportsPerformance-v$version-Windows.zip"
          Compress-Archive -Path "dist/installer_windows/*" -DestinationPath "dist/$zipName" -Force
          Write-Host "Created archive: $zipName"
          
          # 重命名为中文名称（可选）
          $chineseZipName = [System.Text.Encoding]::UTF8.GetString([System.Text.Encoding]::UTF8.GetBytes("体育成绩评估系统-v$version-Windows.zip"))
          if (Test-Path "dist/$zipName") {
            Copy-Item "dist/$zipName" "dist/$chineseZipName" -Force
            Write-Host "Also created Chinese name version"
          }
        shell: pwsh
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            dist/*.zip
            dist/installer_windows/
          retention-days: 30
      
      - name: 创建 Release (仅标签触发时)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.zip
          body: |
            ## 体育成绩评估系统 Windows 安装包
            
            ### 下载说明
            - 下载 `SportsPerformance-*-Windows.zip`
            - 解压到任意位置
            - 运行 `体育成绩评估系统.exe` 或使用 `启动程序.bat`
            
            ### 系统要求
            - Windows 10 或更高版本
            - 约 100MB 磁盘空间
            - 无需安装 Python 环境
            
            ### 功能特性
            - 用户注册和登录管理
            - 体育成绩录入和计算
            - 历史数据查看和分析
            - 数据备份和恢复
            
            详细说明请查看压缩包内的 README.txt 文件。
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
