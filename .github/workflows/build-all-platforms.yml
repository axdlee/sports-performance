name: Build All Platforms

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.3.1)'
        required: false
        default: '1.3.1'

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: æ„å»º Windows å®‰è£…åŒ…
        run: python build.py
      
      - name: åˆ›å»º ZIP å‹ç¼©åŒ…
        run: |
          $version = "${{ github.event.inputs.version }}"
          if ([string]::IsNullOrEmpty($version)) {
            $version = "${{ github.ref_name }}" -replace '^v', ''
          }
          if ([string]::IsNullOrEmpty($version)) {
            $version = "1.3.1"
          }
          $zipName = "SportsPerformance-v$version-Windows.zip"
          Compress-Archive -Path "dist/installer_windows/*" -DestinationPath "dist/$zipName" -Force
          Write-Host "Created archive: $zipName"
        shell: pwsh
      
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: dist/*.zip
          retention-days: 30

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: æ„å»º macOS å®‰è£…åŒ…
        run: python build.py
      
      - name: åˆ›å»º ZIP å‹ç¼©åŒ…
        run: |
          version="${{ github.event.inputs.version }}"
          if [ -z "$version" ]; then
            version="${{ github.ref_name }}"
            version="${version#v}"
          fi
          if [ -z "$version" ]; then
            version="1.3.1"
          fi
          cd dist/installer_macos
          zip -r "../SportsPerformance-v${version}-macOS.zip" .
          echo "Created archive: SportsPerformance-v${version}-macOS.zip"
      
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: dist/*.zip
          retention-days: 30

  create-release:
    name: Create Release
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/windows-installer/*.zip
            artifacts/macos-installer/*.zip
          body: |
            ## ä½“è‚²æˆç»©è¯„ä¼°ç³»ç»Ÿ è·¨å¹³å°å®‰è£…åŒ…
            
            ### ä¸‹è½½è¯´æ˜
            
            #### Windows ç”¨æˆ·
            - ä¸‹è½½ `SportsPerformance-*-Windows.zip`
            - è§£å‹åˆ°ä»»æ„ä½ç½®
            - è¿è¡Œ `ä½“è‚²æˆç»©è¯„ä¼°ç³»ç»Ÿ.exe` æˆ– `å¯åŠ¨ç¨‹åº.bat`
            
            #### macOS ç”¨æˆ·
            - ä¸‹è½½ `SportsPerformance-*-macOS.zip`
            - è§£å‹åå°† `.app` æ‹–åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
            - é¦–æ¬¡æ‰“å¼€å³é”®é€‰æ‹©"æ‰“å¼€"
            
            ### ç³»ç»Ÿè¦æ±‚
            - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
            - **macOS**: macOS 10.13 æˆ–æ›´é«˜ç‰ˆæœ¬
            - çº¦ 100MB ç£ç›˜ç©ºé—´
            - æ— éœ€å®‰è£… Python ç¯å¢ƒ
            
            ### åŠŸèƒ½ç‰¹æ€§
            - âœ¨ ç”¨æˆ·æ³¨å†Œå’Œç™»å½•ç®¡ç†
            - ğŸ“Š ä½“è‚²æˆç»©å½•å…¥å’Œè‡ªåŠ¨è®¡ç®—
            - ğŸ“ˆ å†å²æ•°æ®æŸ¥çœ‹å’Œè¶‹åŠ¿åˆ†æ
            - ğŸ’¾ æ•°æ®å¤‡ä»½å’Œæ¢å¤åŠŸèƒ½
            - ğŸ¨ å‹å¥½çš„å›¾å½¢ç•Œé¢
            
            ### æ•°æ®å­˜å‚¨ä½ç½®
            - **Windows**: `%APPDATA%\SportsPerformance\`
            - **macOS**: `~/Library/Application Support/SportsPerformance/`
            
            è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹å‹ç¼©åŒ…å†…çš„ README.txt æ–‡ä»¶ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
